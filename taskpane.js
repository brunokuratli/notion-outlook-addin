(()=>{let t=null,e=[],n=[],a=null,o=[];const c={};function s(){c.setupSection.classList.remove("hidden"),c.mainSection.classList.add("hidden")}function i(){c.setupSection.classList.add("hidden"),c.mainSection.classList.remove("hidden")}function r(){c.notionToken.value=t||"",s()}async function l(){const e=c.notionToken.value.trim();if(e)if(e.startsWith("secret_")||e.startsWith("ntn_")){y("Pr√ºfe Token...","loading");try{(await d("/users/me")).ok?(t=e,localStorage.setItem("notion_token",e),y("Token gespeichert!","success"),setTimeout(()=>{i(),u(),m()},1e3)):y("Ung√ºltiger Token","error")}catch(t){y("Verbindungsfehler: "+t.message,"error")}}else y("Ung√ºltiges Token-Format","error");else y("Bitte gib einen Token ein","error")}async function d(e,n="GET",a=null){const o={method:n,headers:{Authorization:`Bearer ${t}`,"Notion-Version":"2022-06-28","Content-Type":"application/json"}};a&&(o.body=JSON.stringify(a));const c=await fetch(`https://api.notion.com/v1${e}`,o),s=await c.json();return{ok:c.ok,status:c.status,data:s}}async function m(){y("Lade Datenbanken...","loading");try{const t=await d("/search","POST",{filter:{property:"object",value:"database"},page_size:100});t.ok?(e=t.data.results,c.databaseSelect.innerHTML='<option value="">Datenbank w√§hlen...</option>',e.forEach(t=>{const e=function(t){return t.title&&t.title.length>0?t.title.map(t=>t.plain_text).join(""):"Unbenannte Datenbank"}(t),n=document.createElement("option");n.value=t.id,n.textContent=e,c.databaseSelect.appendChild(n)}),await async function(){try{const t=await d("/search","POST",{filter:{property:"object",value:"page"},page_size:50});t.ok&&(n=t.data.results,c.parentPageSelect.innerHTML='<option value="">Seite w√§hlen (optional)...</option>',n.forEach(t=>{const e=function(t){const e=t.properties;for(const t of Object.keys(e))if("title"===e[t].type&&e[t].title.length>0)return e[t].title.map(t=>t.plain_text).join("");return null}(t);if(e){const n=document.createElement("option");n.value=t.id,n.textContent=e,c.parentPageSelect.appendChild(n)}}))}catch(t){console.error("Error loading pages:",t)}}(),c.status.classList.add("hidden")):y("Fehler beim Laden: "+(t.data.message||"Unbekannt"),"error")}catch(t){y("Netzwerkfehler: "+t.message,"error")}}function u(){const t=Office.context.mailbox.item;if(!t)return void y("Keine E-Mail ausgew√§hlt","error");const e=t.dateTimeCreated?new Date(t.dateTimeCreated):null;a={subject:t.subject,from:t.from?t.from.displayName+" <"+t.from.emailAddress+">":"Unbekannt",dateTime:e?e.toLocaleString("de-DE"):"",dateTimeISO:e?e.toISOString():null},c.emailSubject.textContent=a.subject||"(Kein Betreff)",c.emailFrom.textContent="Von: "+a.from,c.emailDate.textContent=a.dateTime,t.body.getAsync(Office.CoercionType.Text,t=>{t.status===Office.AsyncResultStatus.Succeeded&&(a.bodyText=t.value)}),t.body.getAsync(Office.CoercionType.Html,t=>{t.status===Office.AsyncResultStatus.Succeeded&&(a.bodyHtml=t.value)}),function(t){o=[],t.attachments&&t.attachments.length>0?(c.attachmentsSection.classList.remove("hidden"),c.attachmentCount.textContent=t.attachments.length,c.attachmentsList.innerHTML="",t.attachments.forEach((t,e)=>{o.push({id:t.id,name:t.name,size:t.size,contentType:t.contentType,isInline:t.isInline});const n=document.createElement("li");n.innerHTML=`\n                <input type="checkbox" id="att-${e}" checked>\n                <span class="attachment-name">${function(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}(t.name)}</span>\n                <span class="attachment-size">${g(t.size)}</span>\n            `,c.attachmentsList.appendChild(n)})):c.attachmentsSection.classList.add("hidden")}(t)}function h(){c.includeAttachments.checked&&o.length>0?c.attachmentsSection.classList.remove("hidden"):c.attachmentsSection.classList.add("hidden")}async function p(){const t=c.databaseSelect.value,e=c.parentPageSelect.value;if(t||e){y("Sende zu Notion...","loading"),c.sendToNotionBtn.disabled=!0;try{let n,s=function(){const t=c.includeBody.checked;c.includeHtml.checked;let e=[];return e.push({object:"block",type:"callout",callout:{icon:{type:"emoji",emoji:"üìß"},rich_text:[{type:"text",text:{content:`Von: ${a.from}\nDatum: ${a.dateTime}`}}]}}),e.push({object:"block",type:"divider",divider:{}}),t&&a.bodyText&&b(a.bodyText.trim(),2e3).forEach(t=>{e.push({object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:t}}]}})}),e}();n=t?await async function(t,e){const n=await d(`/databases/${t}`);if(!n.ok)return n;const c=n.data.properties;let s="Name";const i={};for(const[t,e]of Object.entries(c))"title"===e.type&&(s=t),i[t.toLowerCase()]={name:t,type:e.type};const r={[s]:{title:[{text:{content:a.subject||"(Kein Betreff)"}}]}};i.from&&(r[i.from.name]={rich_text:[{text:{content:a.from||""}}]}),i.date&&a.dateTimeISO&&(r[i.date.name]={date:{start:a.dateTimeISO}}),i.status&&"select"===i.status.type&&(r[i.status.name]={select:{name:"Neu"}}),i["has attachments"]&&"checkbox"===i["has attachments"].type&&(r[i["has attachments"].name]={checkbox:o.length>0});const l={parent:{database_id:t},properties:r,children:e};return await d("/pages","POST",l)}(t,s):await async function(t,e){const n={parent:{page_id:t},properties:{title:{title:[{text:{content:a.subject||"(Kein Betreff)"}}]}},children:e};return await d("/pages","POST",n)}(e,s),n.ok?(c.includeAttachments.checked&&o.length>0&&await async function(t){const e=Office.context.mailbox.item,n=[];if(o.forEach((t,e)=>{const a=document.getElementById(`att-${e}`);a&&a.checked&&n.push(t)}),0!==n.length){await d(`/blocks/${t}/children`,"PATCH",{children:[{object:"block",type:"heading_2",heading_2:{rich_text:[{type:"text",text:{content:"Anh√§nge"}}]}}]});for(const a of n)try{const n=await f(e,a.id);if(await d(`/blocks/${t}/children`,"PATCH",{children:[{object:"block",type:"callout",callout:{icon:{type:"emoji",emoji:"üìé"},rich_text:[{type:"text",text:{content:`${a.name} (${g(a.size)})\nTyp: ${a.contentType}`}}]}}]}),k(a.contentType)){const e=b(atob(n),2e3);for(const n of e)await d(`/blocks/${t}/children`,"PATCH",{children:[{object:"block",type:"code",code:{language:x(a.name),rich_text:[{type:"text",text:{content:n}}]}}]})}}catch(t){console.error("Error processing attachment:",a.name,t)}}}(n.data.id),y("Erfolgreich zu Notion gesendet!","success"),n.data.url&&setTimeout(()=>{confirm("In Notion √∂ffnen?")&&window.open(n.data.url,"_blank")},1500)):y("Fehler: "+(n.data.message||"Unbekannt"),"error")}catch(t){y("Fehler: "+t.message,"error")}finally{c.sendToNotionBtn.disabled=!1}}else y("Bitte w√§hle eine Datenbank oder Elternseite","error")}function f(t,e){return new Promise((n,a)=>{t.getAttachmentContentAsync(e,t=>{t.status===Office.AsyncResultStatus.Succeeded?n(t.value.content):a(new Error(t.error.message))})})}function y(t,e){c.status.textContent=t,c.status.className=`status ${e}`,c.status.classList.remove("hidden")}function g(t){return t<1024?t+" B":t<1048576?(t/1024).toFixed(1)+" KB":(t/1048576).toFixed(1)+" MB"}function b(t,e){const n=[];let a=t;for(;a.length>0;){if(a.length<=e){n.push(a);break}let t=a.lastIndexOf("\n",e);(-1===t||t<e/2)&&(t=a.lastIndexOf(" ",e)),(-1===t||t<e/2)&&(t=e),n.push(a.substring(0,t)),a=a.substring(t).trim()}return n}function k(t){return t&&(t.startsWith("text/")||t.includes("json")||t.includes("xml")||t.includes("javascript"))}function x(t){return{js:"javascript",ts:"typescript",py:"python",json:"json",xml:"xml",html:"html",css:"css",md:"markdown",txt:"plain text"}[t.split(".").pop().toLowerCase()]||"plain text"}Office.onReady(e=>{e.host===Office.HostType.Outlook&&(c.setupSection=document.getElementById("setup-section"),c.mainSection=document.getElementById("main-section"),c.notionToken=document.getElementById("notion-token"),c.saveTokenBtn=document.getElementById("save-token-btn"),c.emailSubject=document.getElementById("email-subject"),c.emailFrom=document.getElementById("email-from"),c.emailDate=document.getElementById("email-date"),c.databaseSelect=document.getElementById("database-select"),c.parentPageSelect=document.getElementById("parent-page-select"),c.refreshDbsBtn=document.getElementById("refresh-dbs-btn"),c.includeBody=document.getElementById("include-body"),c.includeAttachments=document.getElementById("include-attachments"),c.includeHtml=document.getElementById("include-html"),c.attachmentsSection=document.getElementById("attachments-section"),c.attachmentCount=document.getElementById("attachment-count"),c.attachmentsList=document.getElementById("attachments-list"),c.sendToNotionBtn=document.getElementById("send-to-notion-btn"),c.status=document.getElementById("status"),c.settingsBtn=document.getElementById("settings-btn"),c.saveTokenBtn.addEventListener("click",l),c.refreshDbsBtn.addEventListener("click",m),c.sendToNotionBtn.addEventListener("click",p),c.settingsBtn.addEventListener("click",r),c.includeAttachments.addEventListener("change",h),t=localStorage.getItem("notion_token"),t?(i(),u(),m()):s())})})();